name: obj_detection_cd

on:
  push: # Trigger when push on develop branch
   branches:
      - develop
        
jobs:
  buildx:
    name: Build and push
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v1
        with:
          ref: develop
      -
        name: Set up Docker Buildx
        id: buildx
        uses: crazy-max/ghaction-docker-buildx@v1.0.4
        with:
          version: latest
      
      -
        name: Available platforms
        run: echo ${{ steps.buildx.outputs.platforms }}
        
      - 
        name: Login to GitHub Docker Registry
        run: echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
      
      #Build&Push -custom model trainer
      -
        name: Build and push custom train ARM container #see: https://github.com/marketplace/actions/docker-buildx
        run: |
          docker buildx build \
            --tag rio05docker/obj_detection_cd:rpi3_mlflow_custom \
            --platform linux/arm/v7 \
            --output "type=image,push=true" \
            --file ./batch_custom_model/Dockerfile \
            ./batch_custom_model/
        
      -
        name: Build and push object detection retrain x86 container #see: https://github.com/marketplace/actions/docker-buildx
        run: |
          docker buildx build \
            --tag rio05docker/obj_detection_cd:x86_retrain_tflite \
            --platform linux \
            --output "type=image,push=true" \
            --file ./real_time_object_detection_edge_tpu/object_detection_transfer_learning/x86/tf2/Dockerfile \
            ./real_time_object_detection_edge_tpu/object_detection_transfer_learning/x86/tf2/
      
      #Build&Push - batch masked rcnn model trainer
      #-
      #  name: Build and push batch masked rcnn model trainer #see: https://github.com/marketplace/actions/docker-buildx
      #  run: |
      #    docker buildx build \
      #      --tag rio05docker/obj_detection_cd:rpi3_mrcnn_${GITHUB_SHA} \
      #      --platform linux/arm/v7 \
      #      --output "type=image,push=true" \
      #      --file ./batch_masked_rcnn/Dockerfile \
      #      ./batch_masked_rcnn/
      
